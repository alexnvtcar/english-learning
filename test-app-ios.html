<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning App - iOS Test</title>
    
    <!-- iOS PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="English Learning">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è iOS -->
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon-180x180.svg">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/apple-touch-icon-ipad-152x152.svg">
    <link rel="apple-touch-icon" sizes="120x120" href="./icons/apple-touch-icon-iphone-120x120.svg">
    
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="animations-fix.css">
    <link rel="stylesheet" href="z-index-fix.css">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* iOS —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .ios-test-banner {
            background: linear-gradient(135deg, #007aff, #5856d6);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
        }
        
        .ios-test-banner.hidden {
            display: none;
        }
        
        /* –°–¥–≤–∏–≥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω–∏–∑ –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ */
        body {
            padding-top: 40px;
        }
    </style>
</head>
<body>
    <!-- iOS —Ç–µ—Å—Ç –±–∞–Ω–Ω–µ—Ä -->
    <div class="ios-test-banner" id="iosTestBanner">
        üçé iOS –≠–º—É–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞ | User Agent: iPhone | <button onclick="toggleBanner()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 2px 8px; border-radius: 4px; margin-left: 10px;">–°–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app">
        <!-- Settings Panel -->
        <div class="settings-panel">
            <button class="settings-btn" onclick="toggleSettingsMenu()" aria-label="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" aria-haspopup="true" aria-expanded="false">
                ‚öôÔ∏è
            </button>
            
            <!-- PWA Install Button -->
            <button id="install-pwa-btn" class="install-pwa-btn" style="display: none;" aria-label="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ">
                üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>

            <button class="save-btn" onclick="saveDataToFirebase()" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Firebase">
                <span class="save-icon">üíæ</span>
                <span class="save-text">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </button>
            <button class="exit-btn" onclick="exitApp()" aria-label="–í—ã—Ö–æ–¥" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏">
                <span class="exit-icon">‚ùå</span>
            </button>
            <div class="settings-menu" id="settingsMenu">
                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
                <div class="settings-close-btn" onclick="closeSettingsMenu()" aria-label="–ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
                    ‚úï
                </div>
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="settings-section">
                    <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="settings-item" onclick="installPWA()" id="pwaInstallMenuItem">
                        üì±
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    </div>
                    <div class="settings-item" onclick="showAccountSelection()">
                        üë§
                        –°–º–µ–Ω–∏—Ç—å —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å
                    </div>
                    <div class="settings-item" onclick="showPinSetup()">
                        üîê
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PIN-–∫–æ–¥
                    </div>
                    <div class="settings-item" onclick="showPinChange()">
                        üîë
                        –°–º–µ–Ω–∏—Ç—å PIN-–∫–æ–¥
                    </div>
                </div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ -->
                <div class="settings-section">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                    <div class="settings-item" onclick="showBackupManager()">
                        üíæ
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏
                    </div>
                    <div class="settings-item" onclick="exportData()">
                        üì§
                        –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </div>
                    <div class="settings-item" onclick="document.getElementById('importFile').click()">
                        üì•
                        –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
                
                <!-- –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ -->
                <div class="settings-section">
                    <h3>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                    <div class="settings-item" onclick="showAbout()">
                        ‚ÑπÔ∏è
                        –û –ø—Ä–æ–≥—Ä–∞–º–º–µ
                    </div>
                    <div class="settings-item" onclick="showHelp()">
                        ‚ùì
                        –ü–æ–º–æ—â—å
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>English Learning App</h1>
                <p>iOS Test Mode</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-value" id="currentLevel">1</div>
                    <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="totalXP">0</div>
                    <div class="stat-label">XP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="achievementsUnlocked">0</div>
                    <div class="stat-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéÅ</div>
                    <div class="stat-value" id="rewardsReceived">0</div>
                    <div class="stat-label">–ù–∞–≥—Ä–∞–¥—ã</div>
                </div>
            </div>
            
            <div class="actions">
                <button class="action-btn" onclick="showTaskModal()">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                </button>
                <button class="action-btn" onclick="showRewardModal()">
                    üéÅ –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
                </button>
            </div>
            
            <div class="ios-debug">
                <h3>üçé iOS Debug Info</h3>
                <div id="iosDebugInfo"></div>
                <button onclick="runIOSTests()" class="test-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã iOS</button>
                <button onclick="openMainApp()" class="test-btn">–û—Ç–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
                <div class="test-info">
                    <p><strong>–í–∞–∂–Ω–æ:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ HTTP —Å–µ—Ä–≤–µ—Ä!</p>
                    <p>URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: <code>http://localhost:8000</code></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyBvQvQvQvQvQvQvQvQvQvQvQvQvQvQvQvQ",
            authDomain: "english-learning-6dd75.firebaseapp.com",
            projectId: "english-learning-6dd75",
            storageBucket: "english-learning-6dd75.appspot.com",
            messagingSenderId: "695373353831",
            appId: "1:695373353831:web:74192c1f632282931155c2"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.db = db;
        window.doc = (collection, docId) => {
            console.log('üìÑ window.doc called with:', collection, docId);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –æ–±—ä–µ–∫—Ç Firestore
            if (collection && typeof collection === 'object' && collection.firestore) {
                // –≠—Ç–æ —É–∂–µ –æ–±—ä–µ–∫—Ç Firestore, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
                return collection;
            }
            if (typeof collection === 'string' && typeof docId === 'string') {
                return db.collection(collection).doc(docId);
            } else {
                console.error('‚ùå Invalid parameters for window.doc:', collection, docId);
                return null;
            }
        };
        window.getDoc = (docRef) => {
            console.log('üìñ window.getDoc called with:', docRef);
            return docRef.get();
        };
        window.setDoc = (docRef, data) => {
            console.log('üíæ window.setDoc called with:', docRef, data);
            return docRef.set(data);
        };
        
        console.log('üî• Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è iOS —Ç–µ—Å—Ç–∞');
    </script>

    <!-- iOS —Ç–µ—Å—Ç —Å–∫—Ä–∏–ø—Ç -->
    <script src="test-ios-functions.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <script src="app.js"></script>
    
    <script>
        // iOS —ç–º—É–ª—è—Ü–∏—è
        function toggleBanner() {
            const banner = document.getElementById('iosTestBanner');
            banner.classList.toggle('hidden');
        }
        
        function runIOSTests() {
            console.log('üß™ –ó–∞–ø—É—Å–∫ iOS —Ç–µ—Å—Ç–æ–≤...');
            if (window.testIOS) {
                window.testIOS.initialization();
            }
        }

        function openMainApp() {
            console.log('üöÄ –û—Ç–∫—Ä—ã—Ç–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            window.open('http://localhost:8000', '_blank');
        }
        
        function updateIOSDebugInfo() {
            const debugDiv = document.getElementById('iosDebugInfo');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            debugDiv.innerHTML = `
                <p><strong>iOS –æ–ø—Ä–µ–¥–µ–ª–µ–Ω:</strong> ${isIOS ? '–î–∞' : '–ù–µ—Ç'}</p>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${navigator.platform}</p>
                <p><strong>–û–Ω–ª–∞–π–Ω:</strong> ${navigator.onLine ? '–î–∞' : '–ù–µ—Ç'}</p>
                <p><strong>localStorage:</strong> ${typeof(Storage) !== "undefined" ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}</p>
                <p><strong>Service Worker:</strong> ${'serviceWorker' in navigator ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}</p>
            `;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üçé iOS —Ç–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            updateIOSDebugInfo();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(updateIOSDebugInfo, 5000);
        });
    </script>
</body>
</html>
