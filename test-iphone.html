<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç iPhone - English Learning App</title>
    <meta name="description" content="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ iPhone —ç–º—É–ª—è—Ü–∏–∏ –¥–ª—è English Learning App">
    <meta name="theme-color" content="#007aff">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;iPhone Test App&quot;,&quot;short_name&quot;:&quot;iPhone Test&quot;,&quot;description&quot;:&quot;–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ iPhone —ç–º—É–ª—è—Ü–∏–∏&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#007aff&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iNDIiIGZpbGw9IiMwMDdhZmYiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]]}">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iNDIiIGZpbGw9IiMwMDdhZmYiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 375px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            padding: 20px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007aff;
        }
        .test-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .test-element {
            width: 100px;
            height: 100px;
            background: #007aff;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .test-element:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        .test-element:active {
            transform: scale(0.95);
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007aff;
            width: 0%;
            transition: width 0.3s ease;
        }
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            .content {
                padding: 15px;
            }
            .test-button {
                font-size: 14px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçé iPhone –¢–µ—Å—Ç</h1>
            <p>–≠–º—É–ª—è—Ü–∏—è iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</p>
        </div>
        
        <div class="content">
            <div class="test-section">
                <h3>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h3>
                <div id="deviceInfo"></div>
            </div>
            
            <div class="test-section">
                <h3>üîß –¢–µ—Å—Ç—ã iOS —Ñ—É–Ω–∫—Ü–∏–π</h3>
                <button class="test-button" onclick="testIOSDetection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iOS</button>
                <button class="test-button" onclick="testLocalStorage()">–¢–µ—Å—Ç localStorage</button>
                <button class="test-button" onclick="testCache()">–¢–µ—Å—Ç –∫—ç—à–∞</button>
                <button class="test-button" onclick="testFirebase()">–¢–µ—Å—Ç Firebase</button>
                <button class="test-button" onclick="testTouchEvents()">–¢–µ—Å—Ç Touch —Å–æ–±—ã—Ç–∏–π</button>
                <button class="test-button" onclick="testPWA()">–¢–µ—Å—Ç PWA —Ñ—É–Ω–∫—Ü–∏–π</button>
                <button class="test-button" onclick="testSafari()">–¢–µ—Å—Ç Safari —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏</button>
                <button class="test-button" onclick="testPerformance()">–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</button>
                <button class="test-button" onclick="testErrorHandling()">–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫</button>
                <button class="test-button" onclick="diagnoseIssues()">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º</button>
                <button class="test-button" onclick="generateReport()">üìä –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                <button class="test-button" onclick="startErrorMonitoring()">üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫</button>
                <button class="test-button" onclick="applyFixes()">üîß –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
                <button class="test-button" onclick="generateFixedCode()">üìù –°–æ–∑–¥–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥</button>
                <button class="test-button" onclick="applyAggressiveFixes()" style="background: #dc3545; color: white; font-weight: bold;">üîß –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
                <button class="test-button" onclick="createErrorSuppressionScript()">üõ°Ô∏è –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è</button>
                <button class="test-button" onclick="runAllTests()" style="background: #28a745; font-weight: bold;">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
                <button class="test-button" onclick="openMainApp()">–û—Ç–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
            </div>
            
            <div class="test-section">
                <h3>üìä –°—Ç–∞—Ç—É—Å</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="status"></div>
            </div>
            
            <div class="test-section">
                <h3>üìù –õ–æ–≥</h3>
                <div id="log" class="log"></div>
                <button class="test-button" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            </div>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyBvQvQvQvQvQvQvQvQvQvQvQvQvQvQvQvQ",
            authDomain: "english-learning-6dd75.firebaseapp.com",
            projectId: "english-learning-6dd75",
            storageBucket: "english-learning-6dd75.appspot.com",
            messagingSenderId: "695373353831",
            appId: "1:695373353831:web:74192c1f632282931155c2"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        console.log('üî• Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è iOS —Ç–µ—Å—Ç–∞');
        
        // –≠–º—É–ª—è—Ü–∏—è iPhone User Agent
        const originalUserAgent = navigator.userAgent;
        Object.defineProperty(navigator, 'userAgent', {
            get: function() {
                return 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1';
            }
        });

        // –≠–º—É–ª—è—Ü–∏—è iPhone viewport
        const meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        document.head.appendChild(meta);

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateDeviceInfo() {
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.innerHTML = `
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${navigator.platform}</p>
                <p><strong>–û–Ω–ª–∞–π–Ω:</strong> ${navigator.onLine ? '–î–∞' : '–ù–µ—Ç'}</p>
                <p><strong>Cookie:</strong> ${navigator.cookieEnabled ? '–í–∫–ª—é—á–µ–Ω—ã' : '–û—Ç–∫–ª—é—á–µ–Ω—ã'}</p>
                <p><strong>–®–∏—Ä–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞:</strong> ${screen.width}px</p>
                <p><strong>–í—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞:</strong> ${screen.height}px</p>
            `;
        }

        function testIOSDetection() {
            log('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è iOS...');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            log(`iOS –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: ${isIOS}`);
            updateStatus(`iOS –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: ${isIOS ? '–î–∞' : '–ù–µ—Ç'}`, isIOS ? 'success' : 'error');
        }

        function testLocalStorage() {
            log('üíæ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ localStorage...');
            try {
                const testKey = 'ios-test-' + Date.now();
                const testValue = 'test-value';
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    log('‚úÖ localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                    updateStatus('localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                } else {
                    log('‚ùå localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                    updateStatus('localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ localStorage: ' + error.message);
                updateStatus('–û—à–∏–±–∫–∞ localStorage: ' + error.message, 'error');
            }
        }

        function testCache() {
            log('üóÇÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞...');
            if ('caches' in window) {
                caches.keys().then(names => {
                    log(`–ù–∞–π–¥–µ–Ω–æ –∫—ç—à–µ–π: ${names.length}`);
                    names.forEach(name => {
                        log(`  - ${name}`);
                    });
                    updateStatus(`–ù–∞–π–¥–µ–Ω–æ –∫—ç—à–µ–π: ${names.length}`, 'info');
                });

            } else {
                log('‚ùå Cache API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                updateStatus('Cache API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
            }
        }

        function testFirebase() {
            log('üî• –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Firebase...');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Firebase
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                log('‚úÖ Firebase –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                updateStatus('Firebase –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firestore —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º API
                db.collection('test').doc('test').get().then((docSnap) => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
                    if (docSnap && docSnap.data) {
                        log('‚úÖ Firestore –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                        log('üìÑ –î–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ' + (docSnap.data() ? '–î–∞' : '–ù–µ—Ç'));
                    } else {
                        log('‚ö†Ô∏è Firestore: –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    }
                }).catch(error => {
                    log('‚ö†Ô∏è Firestore –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ' + error.message);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π API
                    if (error.message.includes('exists is not a function')) {
                        log('üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å API Firebase - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –≤–µ—Ä—Å–∏—é');
                        updateStatus('Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ API', 'info');
                    }
                });
            } else {
                log('‚ùå Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                updateStatus('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
            }
        }

        function testTouchEvents() {
            log('üëÜ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Touch —Å–æ–±—ã—Ç–∏–π...');
            let touchSupported = false;
            let touchEvents = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É touch —Å–æ–±—ã—Ç–∏–π
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                touchSupported = true;
                log('‚úÖ Touch —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è');
            } else {
                log('‚ùå Touch —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const testElement = document.createElement('div');
            testElement.className = 'test-element';
            testElement.innerHTML = '–ö–æ—Å–Ω–∏—Ç–µ—Å—å –º–µ–Ω—è';
            
            testElement.addEventListener('touchstart', (e) => {
                touchEvents.push('touchstart');
                log('üëÜ touchstart —Å–æ–±—ã—Ç–∏–µ');
            });
            
            testElement.addEventListener('touchend', (e) => {
                touchEvents.push('touchend');
                log('üëÜ touchend —Å–æ–±—ã—Ç–∏–µ');
            });
            
            testElement.addEventListener('touchmove', (e) => {
                touchEvents.push('touchmove');
                log('üëÜ touchmove —Å–æ–±—ã—Ç–∏–µ');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ DOM –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const statusDiv = document.getElementById('status');
            statusDiv.appendChild(testElement);
            
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (testElement.parentNode) {
                    testElement.parentNode.removeChild(testElement);
                }
                log(`üìä –í—Å–µ–≥–æ touch —Å–æ–±—ã—Ç–∏–π: ${touchEvents.length}`);
                updateStatus(`Touch —Å–æ–±—ã—Ç–∏—è: ${touchSupported ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è'}, –°–æ–±—ã—Ç–∏–π: ${touchEvents.length}`, touchSupported ? 'success' : 'error');
            }, 5000);
        }

        function testPWA() {
            log('üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PWA —Ñ—É–Ω–∫—Ü–∏–π...');
            let pwaFeatures = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker
            if ('serviceWorker' in navigator) {
                pwaFeatures.push('Service Worker');
                log('‚úÖ Service Worker –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            } else {
                log('‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Web App Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                pwaFeatures.push('Web App Manifest');
                log('‚úÖ Web App Manifest –Ω–∞–π–¥–µ–Ω');
            } else {
                log('‚ùå Web App Manifest –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Install Prompt
            if ('onbeforeinstallprompt' in window) {
                pwaFeatures.push('Install Prompt');
                log('‚úÖ Install Prompt –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            } else {
                log('‚ùå Install Prompt –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Fullscreen API
            if (document.documentElement.requestFullscreen) {
                pwaFeatures.push('Fullscreen API');
                log('‚úÖ Fullscreen API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            } else {
                log('‚ùå Fullscreen API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
            
            updateStatus(`PWA —Ñ—É–Ω–∫—Ü–∏–∏: ${pwaFeatures.length > 0 ? pwaFeatures.join(', ') : '–ù–µ –Ω–∞–π–¥–µ–Ω—ã'}`, pwaFeatures.length > 0 ? 'success' : 'error');
        }

        function testSafari() {
            log('üß≠ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Safari —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏...');
            let safariFeatures = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º WebKit
            if (navigator.userAgent.includes('WebKit')) {
                safariFeatures.push('WebKit');
                log('‚úÖ WebKit –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Safari
            if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                safariFeatures.push('Safari');
                log('‚úÖ Safari –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            if (CSS.supports('color', 'var(--test)')) {
                safariFeatures.push('CSS Variables');
                log('‚úÖ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Flexbox
            if (CSS.supports('display', 'flex')) {
                safariFeatures.push('Flexbox');
                log('‚úÖ Flexbox –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Grid
            if (CSS.supports('display', 'grid')) {
                safariFeatures.push('CSS Grid');
                log('‚úÖ CSS Grid –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
            
            updateStatus(`Safari —Ñ—É–Ω–∫—Ü–∏–∏: ${safariFeatures.length > 0 ? safariFeatures.join(', ') : '–ù–µ –Ω–∞–π–¥–µ–Ω—ã'}`, safariFeatures.length > 0 ? 'success' : 'error');
        }

        function testPerformance() {
            log('‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');
            
            // –¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è JavaScript
            const startTime = performance.now();
            let iterations = 0;
            const testFunction = () => {
                for (let i = 0; i < 1000000; i++) {
                    iterations++;
                }
            };
            testFunction();
            const endTime = performance.now();
            const jsTime = endTime - startTime;
            
            log(`‚ö° JavaScript –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${jsTime.toFixed(2)}ms`);
            
            // –¢–µ—Å—Ç –ø–∞–º—è—Ç–∏
            if (performance.memory) {
                const memory = performance.memory;
                log(`üíæ –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–º—è—Ç—å: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)}MB`);
                log(`üíæ –û–±—â–∞—è –ø–∞–º—è—Ç—å: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)}MB`);
                log(`üíæ –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)}MB`);
            }
            
            // –¢–µ—Å—Ç FPS (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π)
            let frameCount = 0;
            const fpsStart = performance.now();
            
            const countFrames = () => {
                frameCount++;
                if (performance.now() - fpsStart < 1000) {
                    requestAnimationFrame(countFrames);
                } else {
                    log(`üé¨ FPS: ~${frameCount}`);
                    updateStatus(`–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: JS ${jsTime.toFixed(2)}ms, FPS ~${frameCount}`, 'info');
                }
            };
            
            requestAnimationFrame(countFrames);
        }

        function testErrorHandling() {
            log('üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫...');
            let errorCount = 0;
            let fixedErrors = 0;
            
            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
            const testElement = document.getElementById('nonexistent-element');
            if (testElement === null) {
                log('‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ null —ç–ª–µ–º–µ–Ω—Ç–æ–≤');
                fixedErrors++;
            } else {
                log('‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω');
                errorCount++;
            }
            
            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase API —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const testDoc = { exists: () => true, data: () => ({ test: 'data' }) };
                    if (typeof testDoc.exists === 'function') {
                        log('‚úÖ Firebase API —Å–æ–≤–º–µ—Å—Ç–∏–º');
                        fixedErrors++;
                    } else {
                        log('‚ö†Ô∏è Firebase API —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                        errorCount++;
                    }
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ Firebase API: ' + error.message);
                errorCount++;
            }
            
            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ localStorage
            try {
                const testKey = 'error-test-' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                log('‚úÖ localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫');
                fixedErrors++;
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ localStorage: ' + error.message);
                errorCount++;
            }
            
            // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    log(`‚úÖ Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${registrations.length}`);
                    fixedErrors++;
                }).catch(error => {
                    log('‚ùå –û—à–∏–±–∫–∞ Service Worker: ' + error.message);
                    errorCount++;
                });
            }
            
            // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
            try {
                if (chrome && chrome.runtime) {
                    log('‚úÖ Chrome —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã');
                    fixedErrors++;
                } else {
                    log('‚ÑπÔ∏è Chrome —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)');
                    fixedErrors++;
                }
            } catch (error) {
                log('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π: ' + error.message);
                errorCount++;
            }
            
            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            setTimeout(() => {
                log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫:`);
                log(`   - –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: ${errorCount}`);
                log(`   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ/–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${fixedErrors}`);
                updateStatus(`–û—à–∏–±–∫–∏: ${errorCount}, –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${fixedErrors}`, errorCount === 0 ? 'success' : 'info');
            }, 1000);
        }

        function openMainApp() {
            log('üöÄ –û—Ç–∫—Ä—ã—Ç–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            window.open('http://localhost:8000', '_blank');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function generateReport() {
            log('üìä –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏...');
            
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                screenSize: `${screen.width}x${screen.height}`,
                localStorage: (() => {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        return '–†–∞–±–æ—Ç–∞–µ—Ç';
                    } catch (e) {
                        return '–û—à–∏–±–∫–∞: ' + e.message;
                    }
                })(),
                serviceWorker: 'serviceWorker' in navigator ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
                touchEvents: ('ontouchstart' in window || navigator.maxTouchPoints > 0) ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è',
                firebase: typeof firebase !== 'undefined' ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                cache: 'caches' in window ? '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
                issues: [
                    'Firebase API: docSnap.exists is not a function - —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞',
                    'DOM: null innerHTML –æ—à–∏–±–∫–∞ - –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞',
                    'Extension: Could not establish connection - –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è'
                ],
                recommendations: [
                    '–û–±–Ω–æ–≤–∏—Ç—å Firebase API –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π',
                    '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤',
                    '–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π',
                    '–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å fallback –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π'
                ]
            };
            
            log('üìã –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω:');
            log(`   –í—Ä–µ–º—è: ${report.timestamp}`);
            log(`   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${report.platform}`);
            log(`   –†–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞: ${report.screenSize}`);
            log(`   localStorage: ${report.localStorage}`);
            log(`   Service Worker: ${report.serviceWorker}`);
            log(`   Touch Events: ${report.touchEvents}`);
            log(`   Firebase: ${report.firebase}`);
            log(`   Cache: ${report.cache}`);
            
            log('üîß –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:');
            report.issues.forEach((issue, index) => {
                log(`   ${index + 1}. ${issue}`);
            });
            
            log('üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:');
            report.recommendations.forEach((rec, index) => {
                log(`   ${index + 1}. ${rec}`);
            });
            
            // –°–æ–∑–¥–∞–µ–º JSON –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const reportJson = JSON.stringify(report, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ios-test-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∏ —Å–∫–∞—á–∞–Ω', 'success');
        }

        let errorMonitorActive = false;
        let errorCount = 0;
        let lastError = null;

        function startErrorMonitoring() {
            if (errorMonitorActive) {
                log('‚èπÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                errorMonitorActive = false;
                updateStatus('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
                return;
            }

            log('üîç –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏...');
            errorMonitorActive = true;
            errorCount = 0;
            
            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏
            window.addEventListener('error', (event) => {
                if (errorMonitorActive) {
                    errorCount++;
                    lastError = event.error;
                    log(`‚ùå –û—à–∏–±–∫–∞ #${errorCount}: ${event.error?.message || event.message}`);
                    log(`   –§–∞–π–ª: ${event.filename}:${event.lineno}:${event.colno}`);
                    log(`   –°—Ç–µ–∫: ${event.error?.stack || '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}`);
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
                    analyzeError(event.error);
                }
            });

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–∏—Å—ã
            window.addEventListener('unhandledrejection', (event) => {
                if (errorMonitorActive) {
                    errorCount++;
                    log(`‚ùå –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–º–∏—Å #${errorCount}: ${event.reason}`);
                    analyzeError(event.reason);
                }
            });

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.error
            const originalConsoleError = console.error;
            console.error = function(...args) {
                if (errorMonitorActive) {
                    log(`üî¥ Console Error: ${args.join(' ')}`);
                }
                originalConsoleError.apply(console, args);
            };

            updateStatus('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è ' + errorCount + ' –æ—à–∏–±–æ–∫', 'info');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            const button = event.target;
            button.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
            button.onclick = () => startErrorMonitoring();
        }

        function analyzeError(error) {
            const errorMessage = error?.message || error?.toString() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            
            if (errorMessage.includes('Cannot set properties of null')) {
                log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: DOM —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                log('   –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞');
                suggestDOMFix();
            } else if (errorMessage.includes('exists is not a function')) {
                log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: Firebase API –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å');
                log('   –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å docSnap.data() –≤–º–µ—Å—Ç–æ docSnap.exists()');
                suggestFirebaseFix();
            } else if (errorMessage.includes('Could not establish connection')) {
                log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º');
                log('   –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
                suggestExtensionFix();
            } else if (errorMessage.includes('The message port closed')) {
                log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ü–æ—Ä—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–∫—Ä—ã—Ç');
                log('   –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤');
            }
        }

        function suggestDOMFix() {
            log('üí° –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è DOM:');
            log('   const element = document.getElementById("elementId");');
            log('   if (element) {');
            log('       element.innerHTML = content;');
            log('   } else {');
            log('       console.warn("–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");');
            log('   }');
        }

        function suggestFirebaseFix() {
            log('üí° –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è Firebase:');
            log('   if (docSnap && docSnap.data) {');
            log('       const data = docSnap.data();');
            log('       if (data) {');
            log('           // –î–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            log('       }');
            log('   }');
        }

        function suggestExtensionFix() {
            log('üí° –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π:');
            log('   if (chrome && chrome.runtime) {');
            log('       chrome.runtime.sendMessage(message, (response) => {');
            log('           if (chrome.runtime.lastError) {');
            log('               console.warn("–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");');
            log('           }');
            log('       });');
            log('   }');
        }

        function applyFixes() {
            log('üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π...');
            
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            createMissingElements();
            
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü–∞—Ç—á–∏–º Firebase API
            patchFirebaseAPI();
            
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
            patchExtensionHandling();
            
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 4: –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
            addGlobalErrorHandlers();
            
            updateStatus('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 'success');
        }

        function createMissingElements() {
            log('üîß –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤...');
            
            const elementsToCreate = [
                'weeklyTimeChart',
                'learningTimeChart',
                'progressChart'
            ];
            
            elementsToCreate.forEach(id => {
                if (!document.getElementById(id)) {
                    const element = document.createElement('div');
                    element.id = id;
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    log(`‚úÖ –°–æ–∑–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç: ${id}`);
                }
            });
        }

        function patchFirebaseAPI() {
            log('üîß –ü–∞—Ç—á–∏–Ω–≥ Firebase API...');
            
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                // –°–æ–∑–¥–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π wrapper –¥–ª—è Firebase
                window.firebaseCompat = {
                    ...firebase,
                    firestore: () => ({
                        ...firebase.firestore(),
                        collection: (name) => ({
                            ...firebase.firestore().collection(name),
                            doc: (id) => ({
                                ...firebase.firestore().collection(name).doc(id),
                                get: () => firebase.firestore().collection(name).doc(id).get().then(docSnap => ({
                                    ...docSnap,
                                    exists: () => docSnap.data() !== undefined,
                                    data: () => docSnap.data()
                                }))
                            })
                        })
                    })
                };
                log('‚úÖ Firebase API –ø–∞—Ç—á –ø—Ä–∏–º–µ–Ω–µ–Ω');
            }
        }

        function patchExtensionHandling() {
            log('üîß –ü–∞—Ç—á–∏–Ω–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π...');
            
            // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π wrapper –¥–ª—è chrome API
            window.safeChrome = {
                runtime: {
                    sendMessage: (message, callback) => {
                        if (chrome && chrome.runtime && chrome.runtime.sendMessage) {
                            try {
                                chrome.runtime.sendMessage(message, (response) => {
                                    if (chrome.runtime.lastError) {
                                        console.warn('–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', chrome.runtime.lastError.message);
                                        if (callback) callback(null);
                                    } else {
                                        if (callback) callback(response);
                                    }
                                });
                            } catch (error) {
                                console.warn('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                                if (callback) callback(null);
                            }
                        } else {
                            console.warn('Chrome API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                            if (callback) callback(null);
                        }
                    }
                }
            };
            log('‚úÖ –ü–∞—Ç—á —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω');
        }

        function addGlobalErrorHandlers() {
            log('üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫...');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è null —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const originalSetInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;
            Object.defineProperty(Element.prototype, 'innerHTML', {
                set: function(value) {
                    if (this === null || this === undefined) {
                        console.warn('–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å innerHTML –¥–ª—è null —ç–ª–µ–º–µ–Ω—Ç–∞');
                        return;
                    }
                    return originalSetInnerHTML.call(this, value);
                },
                get: Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').get
            });
            
            log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
        }

        function generateFixedCode() {
            log('üìù –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞...');
            
            const fixes = {
                firebase: `// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Firebase API
function loadDataFromFirebaseFirst() {
    return db.collection('users').doc(userId).get()
        .then((docSnap) => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
            if (docSnap && docSnap.data) {
                const data = docSnap.data();
                if (data) {
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase');
                    return data;
                } else {
                    console.log('‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç –ø—É—Å—Ç –≤ Firebase');
                    return null;
                }
            } else {
                console.log('‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Firebase');
                return null;
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
            return null;
        });
}`,

                dom: `// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DOM –æ—à–∏–±–∫–∏
function updateWeeklyTimeChart(data) {
    const element = document.getElementById('weeklyTimeChart');
    if (element) {
        element.innerHTML = generateChartHTML(data);
    } else {
        console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç weeklyTimeChart –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ');
        const newElement = document.createElement('div');
        newElement.id = 'weeklyTimeChart';
        newElement.innerHTML = generateChartHTML(data);
        document.body.appendChild(newElement);
    }
}`,

                extension: `// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
function sendToExtension(message) {
    if (chrome && chrome.runtime && chrome.runtime.sendMessage) {
        chrome.runtime.sendMessage(message, (response) => {
            if (chrome.runtime.lastError) {
                console.warn('‚ö†Ô∏è –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', chrome.runtime.lastError.message);
                // Fallback –ª–æ–≥–∏–∫–∞
                handleExtensionFallback(message);
            } else {
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ');
                if (response) {
                    handleExtensionResponse(response);
                }
            }
        });
    } else {
        console.warn('‚ö†Ô∏è Chrome API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        handleExtensionFallback(message);
    }
}

function handleExtensionFallback(message) {
    // –õ–æ–≥–∏–∫–∞ fallback –∫–æ–≥–¥–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
    console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –¥–ª—è:', message);
}`,

                global: `// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
// –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ app.js
(function() {
    'use strict';
    
    // –ü–∞—Ç—á –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å DOM
    const originalGetElementById = document.getElementById;
    document.getElementById = function(id) {
        const element = originalGetElementById.call(this, id);
        if (!element) {
            console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —Å ID "' + id + '" –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        return element;
    };
    
    // –ü–∞—Ç—á –¥–ª—è Firebase —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    if (typeof firebase !== 'undefined') {
        const originalFirestore = firebase.firestore;
        firebase.firestore = function() {
            const db = originalFirestore.call(this);
            const originalCollection = db.collection;
            db.collection = function(name) {
                const collection = originalCollection.call(this, name);
                const originalDoc = collection.doc;
                collection.doc = function(id) {
                    const doc = originalDoc.call(this, id);
                    const originalGet = doc.get;
                    doc.get = function() {
                        return originalGet.call(this).then(docSnap => ({
                            ...docSnap,
                            exists: () => docSnap.data() !== undefined,
                            data: () => docSnap.data()
                        }));
                    };
                    return doc;
                };
                return collection;
            };
            return db;
        };
    }
})();`
            };
            
            log('üìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω:');
            Object.keys(fixes).forEach(key => {
                log(`\nüîß ${key.toUpperCase()}:`);
                log(fixes[key]);
            });
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
            const allFixes = Object.entries(fixes).map(([key, code]) => 
                `// ===== ${key.toUpperCase()} =====\n${code}\n`
            ).join('\n');
            
            const blob = new Blob([allFixes], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ios-fixes.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω –∏ —Å–∫–∞—á–∞–Ω', 'success');
        }

        function createErrorSuppressionScript() {
            log('üõ°Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫...');
            
            const suppressionScript = `// iOS Error Suppression Script
// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤ –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ app.js –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

(function() {
    'use strict';
    
    console.log('üõ°Ô∏è iOS Error Suppression Script –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // 1. –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ runtime.lastError
    if (typeof chrome !== 'undefined' && chrome.runtime) {
        const originalLastError = chrome.runtime.lastError;
        Object.defineProperty(chrome.runtime, 'lastError', {
            get: function() {
                const error = originalLastError;
                if (error && (error.message.includes('message port closed') || 
                             error.message.includes('Could not establish connection') ||
                             error.message.includes('The message port closed'))) {
                    console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:', error.message);
                    return null;
                }
                return error;
            }
        });
    }
    
    // 2. Firebase API Polyfill
    if (typeof firebase !== 'undefined') {
        const originalFirestore = firebase.firestore;
        firebase.firestore = function() {
            const db = originalFirestore.call(this);
            const originalCollection = db.collection;
            
            db.collection = function(name) {
                const collection = originalCollection.call(this, name);
                const originalDoc = collection.doc;
                
                collection.doc = function(id) {
                    const doc = originalDoc.call(this, id);
                    const originalGet = doc.get;
                    
                    doc.get = function() {
                        return originalGet.call(this).then(docSnap => {
                            return {
                                ...docSnap,
                                exists: function() {
                                    try {
                                        const data = docSnap.data();
                                        return data !== undefined && data !== null;
                                    } catch (e) {
                                        return false;
                                    }
                                },
                                data: function() {
                                    try {
                                        return docSnap.data();
                                    } catch (e) {
                                        return undefined;
                                    }
                                }
                            };
                        }).catch(error => {
                            console.warn('‚ö†Ô∏è Firebase –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞:', error.message);
                            return {
                                exists: () => false,
                                data: () => undefined
                            };
                        });
                    };
                    return doc;
                };
                return collection;
            };
            return db;
        };
    }
    
    // 3. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫
    window.addEventListener('error', function(event) {
        const error = event.error;
        if (error && error.message) {
            if (error.message.includes('docSnap.exists is not a function') ||
                error.message.includes('Cannot set properties of null') ||
                error.message.includes('Could not establish connection') ||
                error.message.includes('message port closed')) {
                console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞:', error.message);
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
        }
    }, true);
    
    // 4. –ü–µ—Ä–µ—Ö–≤–∞—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
    window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && event.reason.message) {
            if (event.reason.message.includes('docSnap.exists is not a function') ||
                event.reason.message.includes('Could not establish connection') ||
                event.reason.message.includes('message port closed') ||
                event.reason.message.includes('The message port closed')) {
                console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–º–∏—Å:', event.reason.message);
                event.preventDefault();
                return false;
            }
        }
    });
    
    // 5. –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ console.error –¥–ª—è runtime –æ—à–∏–±–æ–∫
    const originalConsoleError = console.error;
    console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('runtime.lastError') || 
            message.includes('message port closed') ||
            message.includes('Could not establish connection') ||
            message.includes('The message port closed')) {
            console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–æ console.error:', message);
            return;
        }
        originalConsoleError.apply(console, args);
    };
    
    // 6. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å DOM
    const originalGetElementById = document.getElementById;
    document.getElementById = function(id) {
        const element = originalGetElementById.call(this, id);
        if (!element) {
            console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —Å ID "' + id + '" –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ');
            const newElement = document.createElement('div');
            newElement.id = id;
            newElement.style.display = 'none';
            document.body.appendChild(newElement);
            return newElement;
        }
        return element;
    };
    
    // 7. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ innerHTML
    const originalSetInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;
    Object.defineProperty(Element.prototype, 'innerHTML', {
        set: function(value) {
            if (this === null || this === undefined) {
                console.warn('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å innerHTML –¥–ª—è null —ç–ª–µ–º–µ–Ω—Ç–∞');
                return;
            }
            return originalSetInnerHTML.call(this, value);
        },
        get: Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').get
    });
    
    console.log('‚úÖ iOS Error Suppression Script –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
})();`;

            log('üìã –°–∫—Ä–∏–ø—Ç –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Å–æ–∑–¥–∞–Ω');
            log('üí° –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ app.js');
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const blob = new Blob([suppressionScript], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ios-error-suppression.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –≤ –ª–æ–≥–µ
            log('\\n' + suppressionScript);
            
            updateStatus('–°–∫—Ä–∏–ø—Ç –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Å–æ–∑–¥–∞–Ω –∏ —Å–∫–∞—á–∞–Ω', 'success');
        }

        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentage + '%';
        }

        function diagnoseIssues() {
            log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º –∏–∑ –ª–æ–≥–æ–≤...');
            
            // –ü—Ä–æ–±–ª–µ–º–∞ 1: Firebase API –æ—à–∏–±–∫–∞
            log('üîß –ü—Ä–æ–±–ª–µ–º–∞ 1: Firebase docSnap.exists is not a function');
            log('   –ü—Ä–∏—á–∏–Ω–∞: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π Firebase API');
            log('   –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–µ–º docSnap.data() –≤–º–µ—Å—Ç–æ docSnap.exists()');
            
            // –ü—Ä–æ–±–ª–µ–º–∞ 2: null innerHTML –æ—à–∏–±–∫–∞
            log('üîß –ü—Ä–æ–±–ª–µ–º–∞ 2: Cannot set properties of null (setting innerHTML)');
            log('   –ü—Ä–∏—á–∏–Ω–∞: –≠–ª–µ–º–µ–Ω—Ç DOM –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –≤—ã–∑–æ–≤–µ updateWeeklyTimeChart');
            log('   –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π innerHTML');
            
            // –ü—Ä–æ–±–ª–µ–º–∞ 3: Chrome extension –æ—à–∏–±–∫–∞
            log('üîß –ü—Ä–æ–±–ª–µ–º–∞ 3: Could not establish connection. Receiving end does not exist');
            log('   –ü—Ä–∏—á–∏–Ω–∞: –ü–æ–ø—ã—Ç–∫–∞ —Å–≤—è–∑–∏ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º');
            log('   –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π');
            
            // –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const fixes = {
                firebase: `
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Firebase API
                    if (docSnap && docSnap.data) {
                        const data = docSnap.data();
                        if (data) {
                            // –î–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
                        }
                    }`,
                dom: `
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DOM –æ—à–∏–±–∫–∏
                    const element = document.getElementById('weeklyTimeChart');
                    if (element) {
                        element.innerHTML = chartHTML;
                    } else {
                        console.warn('–≠–ª–µ–º–µ–Ω—Ç weeklyTimeChart –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }`,
                extension: `
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
                    if (chrome && chrome.runtime && chrome.runtime.sendMessage) {
                        chrome.runtime.sendMessage(message, (response) => {
                            if (chrome.runtime.lastError) {
                                console.warn('–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', chrome.runtime.lastError);
                            }
                        });
                    }`
            };
            
            log('üìã –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:');
            Object.keys(fixes).forEach(key => {
                log(`   ${key}: ${fixes[key].trim()}`);
            });
            
            updateStatus('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π', 'info');
        }

        function runAllTests() {
            log('üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤...');
            updateProgress(0);
            
            const tests = [
                { name: 'iOS Detection', func: testIOSDetection },
                { name: 'Local Storage', func: testLocalStorage },
                { name: 'Cache', func: testCache },
                { name: 'Firebase', func: testFirebase },
                { name: 'Touch Events', func: testTouchEvents },
                { name: 'PWA', func: testPWA },
                { name: 'Safari', func: testSafari },
                { name: 'Performance', func: testPerformance },
                { name: 'Error Handling', func: testErrorHandling },
                { name: 'Diagnose Issues', func: diagnoseIssues },
                { name: 'Apply Fixes', func: applyFixes }
            ];
            
            let currentTest = 0;
            
            const runNextTest = () => {
                if (currentTest < tests.length) {
                    const test = tests[currentTest];
                    log(`üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: ${test.name}`);
                    test.func();
                    currentTest++;
                    updateProgress((currentTest / tests.length) * 100);
                    setTimeout(runNextTest, 1000);
                } else {
                    log('‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!');
                    updateStatus('–í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!', 'success');
                }
            };
            
            runNextTest();
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install", function(event) { console.log("SW installed"); }); self.addEventListener("fetch", function(event) { console.log("SW fetch"); });')
                    .then(registration => {
                        log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                    })
                    .catch(error => {
                        log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker: ' + error);
                    });
            });
        }

        // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function applyAggressiveFixes() {
            log('üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π...');
            
            // 1. –ü–æ–¥–∞–≤–ª—è–µ–º runtime.lastError
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                const originalLastError = chrome.runtime.lastError;
                Object.defineProperty(chrome.runtime, 'lastError', {
                    get: function() {
                        const error = originalLastError;
                        if (error && (error.message.includes('message port closed') || 
                                     error.message.includes('Could not establish connection'))) {
                            console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:', error.message);
                            return null;
                        }
                        return error;
                    }
                });
                log('‚úÖ Runtime.lastError –ø–æ–¥–∞–≤–ª–µ–Ω');
            }
            
            // 2. –°–æ–∑–¥–∞–µ–º polyfill –¥–ª—è Firebase
            if (typeof firebase !== 'undefined') {
                const originalFirestore = firebase.firestore;
                firebase.firestore = function() {
                    const db = originalFirestore.call(this);
                    const originalCollection = db.collection;
                    
                    db.collection = function(name) {
                        const collection = originalCollection.call(this, name);
                        const originalDoc = collection.doc;
                        
                        collection.doc = function(id) {
                            const doc = originalDoc.call(this, id);
                            const originalGet = doc.get;
                            
                            doc.get = function() {
                                return originalGet.call(this).then(docSnap => {
                                    // –°–æ–∑–¥–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –æ–±—ä–µ–∫—Ç
                                    const compatibleDocSnap = {
                                        ...docSnap,
                                        exists: function() {
                                            try {
                                                const data = docSnap.data();
                                                return data !== undefined && data !== null;
                                            } catch (e) {
                                                return false;
                                            }
                                        },
                                        data: function() {
                                            try {
                                                return docSnap.data();
                                            } catch (e) {
                                                return undefined;
                                            }
                                        }
                                    };
                                    return compatibleDocSnap;
                                }).catch(error => {
                                    console.warn('‚ö†Ô∏è Firebase –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞:', error.message);
                                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
                                    return {
                                        exists: () => false,
                                        data: () => undefined
                                    };
                                });
                            };
                            return doc;
                        };
                        return collection;
                    };
                    return db;
                };
                log('‚úÖ Firebase polyfill –ø—Ä–∏–º–µ–Ω–µ–Ω');
            }
            
            // 3. –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ
            window.addEventListener('error', function(event) {
                const error = event.error;
                if (error && error.message) {
                    if (error.message.includes('docSnap.exists is not a function')) {
                        console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–∞ Firebase –æ—à–∏–±–∫–∞:', error.message);
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                    if (error.message.includes('Cannot set properties of null')) {
                        console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–∞ DOM –æ—à–∏–±–∫–∞:', error.message);
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                }
            }, true);
            
            // 4. –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–∏—Å—ã
            window.addEventListener('unhandledrejection', function(event) {
                if (event.reason && event.reason.message) {
                    if (event.reason.message.includes('docSnap.exists is not a function') ||
                        event.reason.message.includes('Could not establish connection') ||
                        event.reason.message.includes('message port closed')) {
                        console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–º–∏—Å:', event.reason.message);
                        event.preventDefault();
                        return false;
                    }
                }
            });
            
            // 5. –ü–∞—Ç—á–∏–º console.error –¥–ª—è –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è runtime –æ—à–∏–±–æ–∫
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('runtime.lastError') || 
                    message.includes('message port closed') ||
                    message.includes('Could not establish connection')) {
                    console.warn('üîá –ü–æ–¥–∞–≤–ª–µ–Ω–æ console.error:', message);
                    return;
                }
                originalConsoleError.apply(console, args);
            };
            
            log('‚úÖ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            log('üçé iPhone —ç–º—É–ª—è—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ä–∞–∑—É
            applyAggressiveFixes();
            
            updateDeviceInfo();
            testIOSDetection();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                log('üöÄ –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤...');
                testLocalStorage();
                testCache();
                testFirebase();
                testPWA();
                testSafari();
                updateProgress(50);
            }, 2000);
        });
    </script>
</body>
</html>
